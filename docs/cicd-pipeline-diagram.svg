<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" style="background-color: #ffffff;">
  <defs>
    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#495057"/>
    </marker>

    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#40c057"/>
    </marker>

    <marker id="arrowhead-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7950f2"/>
    </marker>

    <!-- Fonts -->
    <style>
      text { font-family: 'Segoe UI', system-ui, sans-serif; }
      .title { font-size: 24px; font-weight: bold; fill: #1e1e1e; }
      .subtitle { font-size: 14px; fill: #495057; }
      .label { font-size: 13px; fill: #1e1e1e; font-weight: 500; }
      .small { font-size: 11px; fill: #495057; }
      .tiny { font-size: 9px; fill: #868e96; }
      .stage-label { font-size: 10px; fill: #495057; font-weight: 600; }
    </style>
  </defs>

  <!-- Title -->
  <text x="500" y="35" text-anchor="middle" class="title">CI/CD Pipeline Flow</text>
  <text x="500" y="55" text-anchor="middle" class="subtitle">Helm Chart Deployment via Gitea Package Registry</text>

  <!-- Developer -->
  <rect x="400" y="80" width="200" height="50" rx="8" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
  <text x="500" y="105" text-anchor="middle" class="label">ğŸ‘¨â€ğŸ’» Developer</text>
  <text x="500" y="120" text-anchor="middle" class="small">git push origin main</text>

  <!-- Arrow to Gitea -->
  <line x1="500" y1="130" x2="500" y2="170" stroke="#495057" stroke-width="2.5" marker-end="url(#arrowhead)"/>
  <text x="520" y="155" class="small">push code</text>

  <!-- Gitea Repository -->
  <rect x="350" y="180" width="300" height="80" rx="8" fill="#ffffff" stroke="#40c057" stroke-width="2.5"/>
  <text x="500" y="210" text-anchor="middle" class="label">ğŸ“¦ Gitea Repository</text>
  <text x="500" y="230" text-anchor="middle" class="small">remotelab/django-app</text>
  <text x="500" y="245" text-anchor="middle" class="tiny">gitea:3000/remotelab/django-app.git (includes chart/)</text>

  <!-- Arrow to Actions -->
  <line x1="500" y1="260" x2="500" y2="300" stroke="#495057" stroke-width="2.5" marker-end="url(#arrowhead)"/>
  <text x="530" y="285" class="small">triggers webhook</text>

  <!-- Gitea Actions Pipeline -->
  <rect x="30" y="310" width="940" height="180" rx="12" fill="#fff5f5" stroke="#fa5252" stroke-width="2.5"/>
  <text x="50" y="340" class="label" fill="#c92a2a">ğŸ”„ Gitea Actions Pipeline (Actions Runner + Docker-in-Docker)</text>

  <!-- Stage 1: Test -->
  <rect x="50" y="360" width="200" height="110" rx="8" fill="#ffffff" stroke="#fab005" stroke-width="2"/>
  <text x="150" y="385" text-anchor="middle" class="stage-label">STAGE 1: TEST</text>
  <text x="150" y="405" text-anchor="middle" class="small">â€¢ Python 3.11 setup</text>
  <text x="150" y="422" text-anchor="middle" class="small">â€¢ Install dependencies</text>
  <text x="150" y="439" text-anchor="middle" class="small">â€¢ Run unit tests</text>
  <text x="150" y="456" text-anchor="middle" class="small">â€¢ Code quality (flake8)</text>

  <!-- Arrow from Test to Build -->
  <line x1="250" y1="415" x2="280" y2="415" stroke="#40c057" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <text x="265" y="405" class="tiny" fill="#40c057">âœ“ pass</text>

  <!-- Stage 2: Build & Push Image -->
  <rect x="290" y="360" width="200" height="110" rx="8" fill="#ffffff" stroke="#339af0" stroke-width="2"/>
  <text x="390" y="385" text-anchor="middle" class="stage-label">STAGE 2: BUILD IMAGE</text>
  <text x="390" y="405" text-anchor="middle" class="small">â€¢ Build Docker image</text>
  <text x="390" y="422" text-anchor="middle" class="small">â€¢ Tag: gitea:3000/.../1.0.X</text>
  <text x="390" y="439" text-anchor="middle" class="small">â€¢ Push to Gitea Registry</text>
  <text x="390" y="456" text-anchor="middle" class="tiny">(skopeo copy with metadata)</text>

  <!-- Arrow from Build to Helm -->
  <line x1="490" y1="415" x2="520" y2="415" stroke="#40c057" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <text x="505" y="405" class="tiny" fill="#40c057">âœ“ push</text>

  <!-- Stage 3: Package Helm Chart (NEW - highlighted) -->
  <rect x="530" y="360" width="200" height="110" rx="8" fill="#e7f5ff" stroke="#7950f2" stroke-width="2.5"/>
  <text x="630" y="385" text-anchor="middle" class="stage-label" fill="#7950f2">STAGE 3: HELM CHART</text>
  <text x="630" y="405" text-anchor="middle" class="small">â€¢ Update Chart.yaml version</text>
  <text x="630" y="422" text-anchor="middle" class="small">â€¢ Update values.yaml tag</text>
  <text x="630" y="439" text-anchor="middle" class="small">â€¢ helm package</text>
  <text x="630" y="456" text-anchor="middle" class="small" fill="#7950f2">â€¢ helm push (OCI)</text>

  <!-- Arrow from Helm to Security -->
  <line x1="730" y1="415" x2="760" y2="415" stroke="#40c057" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <text x="745" y="405" class="tiny" fill="#40c057">âœ“ push</text>

  <!-- Stage 4: Security Scan -->
  <rect x="770" y="360" width="180" height="110" rx="8" fill="#ffffff" stroke="#868e96" stroke-width="2"/>
  <text x="860" y="385" text-anchor="middle" class="stage-label">STAGE 4: SECURITY</text>
  <text x="860" y="405" text-anchor="middle" class="small">â€¢ Trivy vulnerability scan</text>
  <text x="860" y="422" text-anchor="middle" class="small">â€¢ Check HIGH/CRITICAL</text>
  <text x="860" y="439" text-anchor="middle" class="small">â€¢ Generate report</text>
  <text x="860" y="456" text-anchor="middle" class="tiny">(trivy image scan)</text>

  <!-- Arrow down from Helm stage to Registry -->
  <line x1="630" y1="470" x2="630" y2="520" stroke="#7950f2" stroke-width="2.5" marker-end="url(#arrowhead-purple)"/>
  <text x="655" y="500" class="small" fill="#7950f2">OCI artifacts</text>

  <!-- Container Registry (updated to show both image and chart) -->
  <rect x="250" y="530" width="500" height="100" rx="8" fill="#fff9db" stroke="#fab005" stroke-width="2.5"/>
  <text x="500" y="555" text-anchor="middle" class="label">ğŸ“¦ Gitea OCI Registry</text>
  <text x="500" y="573" text-anchor="middle" class="tiny">Built-in Gitea package registry (OCI-compliant)</text>

  <!-- Two sub-boxes for images and charts -->
  <rect x="270" y="582" width="210" height="38" rx="4" fill="#ffffff" stroke="#339af0" stroke-width="1.5"/>
  <text x="375" y="600" text-anchor="middle" class="small">ğŸ³ Container Images</text>
  <text x="375" y="614" text-anchor="middle" class="tiny">django-app:1.0.X</text>

  <rect x="520" y="582" width="210" height="38" rx="4" fill="#e7f5ff" stroke="#7950f2" stroke-width="2"/>
  <text x="625" y="600" text-anchor="middle" class="small" fill="#7950f2">âˆ Helm Charts (Package API)</text>
  <text x="625" y="614" text-anchor="middle" class="tiny" fill="#7950f2">django-app-0.1.X.tgz</text>

  <!-- Arrow from Registry to ArgoCD (direct - no Image Updater!) -->
  <line x1="500" y1="630" x2="500" y2="680" stroke="#7950f2" stroke-width="2.5" marker-end="url(#arrowhead-purple)"/>
  <text x="530" y="660" class="small" fill="#7950f2">watches chart</text>

  <!-- ArgoCD GitOps (updated - watches Helm repo directly) -->
  <rect x="280" y="690" width="440" height="100" rx="8" fill="#f3f0ff" stroke="#7950f2" stroke-width="2.5"/>
  <text x="500" y="720" text-anchor="middle" class="label" fill="#5f3dc4">âš™ï¸ ArgoCD GitOps Engine</text>
  <text x="500" y="742" text-anchor="middle" class="small">â€¢ Watches Helm repo: gitea:3000/api/packages/remotelab/helm</text>
  <text x="500" y="759" text-anchor="middle" class="small">â€¢ Detects new chart version â†’ triggers sync</text>
  <text x="500" y="780" text-anchor="middle" class="tiny" fill="#7950f2">Auto-sync enabled â€¢ No Image Updater needed â€¢ targetRevision: "*"</text>

  <!-- Arrow to Kubernetes -->
  <line x1="500" y1="790" x2="500" y2="830" stroke="#40c057" stroke-width="2.5" marker-end="url(#arrowhead)"/>
  <text x="530" y="815" class="small" fill="#40c057">helm template + apply</text>

  <!-- Kubernetes Deployment -->
  <rect x="50" y="840" width="900" height="90" rx="12" fill="#ebfbee" stroke="#40c057" stroke-width="2.5"/>
  <text x="70" y="865" class="label" fill="#2f9e44">â˜¸ï¸ Kubernetes Cluster (namespace: applications)</text>

  <!-- Old Pod -->
  <rect x="120" y="880" width="180" height="40" rx="8" fill="#f1f3f5" stroke="#868e96" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="210" y="900" text-anchor="middle" class="small" fill="#868e96">django-xxxxxxxxx-old</text>
  <text x="210" y="914" text-anchor="middle" class="tiny" fill="#868e96">image: ...django-app:1.0.5 (old)</text>

  <!-- Arrow showing rolling update -->
  <line x1="300" y1="900" x2="360" y2="900" stroke="#40c057" stroke-width="3" marker-end="url(#arrowhead-green)"/>
  <text x="330" y="892" class="small" fill="#40c057">rolling update</text>

  <!-- New Pod -->
  <rect x="370" y="880" width="180" height="40" rx="8" fill="#ffffff" stroke="#40c057" stroke-width="2.5"/>
  <text x="460" y="900" text-anchor="middle" class="label" fill="#2f9e44">django-xxxxxxxxx-new</text>
  <text x="460" y="914" text-anchor="middle" class="small">image: ...django-app:1.0.6 âœ“</text>

  <!-- Linkerd sidecar note -->
  <rect x="590" y="880" width="180" height="40" rx="8" fill="#e7f5ff" stroke="#339af0" stroke-width="1.5"/>
  <text x="680" y="900" text-anchor="middle" class="small">ğŸ”’ Linkerd Sidecar</text>
  <text x="680" y="914" text-anchor="middle" class="tiny">Automatic mTLS encryption</text>

  <!-- Running Application -->
  <rect x="800" y="875" width="130" height="50" rx="8" fill="#d3f9d8" stroke="#40c057" stroke-width="2"/>
  <text x="865" y="898" text-anchor="middle" class="label" fill="#2f9e44">âœ… Live</text>
  <text x="865" y="915" text-anchor="middle" class="tiny">/django/api/</text>

  <!-- Timeline annotations -->
  <rect x="50" y="950" width="900" height="40" rx="6" fill="#f8f9fa" stroke="#495057" stroke-width="1"/>
  <text x="70" y="968" class="tiny">â±ï¸ Timeline: Push â†’ Test (30s) â†’ Build Image (60s) â†’ Package Helm (10s) â†’ Scan (30s) â†’ ArgoCD Detect (2min) â†’ Deploy (30s)</text>
  <text x="70" y="982" class="tiny" fill="#40c057">Total deployment time: ~3-4 minutes from code push to running application</text>

</svg>
