apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-init-repo
  namespace: applications
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: gitea-init-repo
      annotations:
        linkerd.io/inject: disabled
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-gitea
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          echo "Waiting for Gitea to be ready..."
          attempts=0
          max_attempts=60
          until curl -sf http://gitea:3000/api/healthz > /dev/null; do
            attempts=$((attempts + 1))
            if [ $attempts -ge $max_attempts ]; then
              echo "Gitea failed to become ready after $max_attempts attempts"
              exit 1
            fi
            echo "Gitea not ready yet, waiting... (attempt $attempts/$max_attempts)"
            sleep 5
          done
          echo "Gitea is ready!"
          sleep 5
      containers:
      - name: init-repo
        image: alpine/git:latest
        command:
        - sh
        - -c
        - |
          set -ex

          # Install curl and jq for API calls
          apk add --no-cache curl jq

          echo "=========================================="
          echo "Initializing Django App Repository"
          echo "=========================================="

          GITEA_URL="http://gitea:3000"
          USERNAME="remotelab"
          PASSWORD="remotelab"
          REPO_NAME="django-app"
          GHCR_IMAGE="ghcr.io/lpmi-13/k3s-remotelab-django:latest"
          GITEA_REGISTRY="gitea:3000"
          GITEA_IMAGE="$GITEA_REGISTRY/$USERNAME/$REPO_NAME:1.0.1"

          # Check if repository exists
          echo "Checking if repository exists..."
          REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME")

          if [ "$REPO_CHECK" = "200" ]; then
            echo "Repository already exists. Deleting for fresh initialization..."
            curl -X DELETE "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME" \
              -u "$USERNAME:$PASSWORD" || {
                echo "Failed to delete existing repository"
                exit 1
              }
            sleep 3
          fi

          # Create repository under user account
          echo "Creating repository '$REPO_NAME' for user '$USERNAME'..."
          CREATE_RESPONSE=$(curl -X POST "$GITEA_URL/api/v1/user/repos" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d "{
              \"name\": \"$REPO_NAME\",
              \"description\": \"Django Application with CI/CD\",
              \"private\": false,
              \"auto_init\": true,
              \"default_branch\": \"main\"
            }")

          echo "Repository creation response: $CREATE_RESPONSE"

          # Wait a moment for repository to be fully initialized
          sleep 5

          # Configure git
          git config --global user.email "remotelab@localhost.local"
          git config --global user.name "Remotelab"
          git config --global init.defaultBranch main

          # Clone the source code from GitHub to get workflow files
          echo "Cloning repository from GitHub to get workflow configuration..."
          GITHUB_REPO="https://github.com/lpmi-13/k3s-remotelab.git"
          CLONE_DIR="/tmp/source"
          REPO_DIR="/workspace/repo"

          # Clone with retry logic for network resilience
          clone_attempts=0
          max_clone_attempts=3
          until git clone "$GITHUB_REPO" "$CLONE_DIR"; do
            clone_attempts=$((clone_attempts + 1))
            if [ $clone_attempts -ge $max_clone_attempts ]; then
              echo "Failed to clone repository after $max_clone_attempts attempts"
              exit 1
            fi
            echo "Clone attempt $clone_attempts failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "Successfully cloned repository from GitHub"

          # Prepare repository directory with Django app code
          echo "Extracting Django app workflow configuration from repository..."
          mkdir -p "$REPO_DIR"

          # Copy Django app directory contents
          if [ ! -d "$CLONE_DIR/sample-django-app" ]; then
            echo "Error: sample-django-app directory not found in cloned repository"
            echo "Contents of clone directory:"
            ls -la "$CLONE_DIR/"
            exit 1
          fi

          cp -r "$CLONE_DIR/sample-django-app/"* "$REPO_DIR/"

          # Verify Django app was copied correctly
          cd "$REPO_DIR"
          if [ ! -f "manage.py" ]; then
            echo "Error: Django source code not properly copied"
            echo "Contents of repository directory:"
            ls -la "$REPO_DIR/"
            exit 1
          fi

          echo "Django app extracted successfully"
          echo "Repository contents:"
          ls -la "$REPO_DIR/"

          # Initialize git repository
          echo "Initializing git repository..."
          git init
          git add .
          git commit -m "Initial commit: Django application with Gitea Actions CI/CD

          This commit includes:
          - Django application code
          - Gitea Actions workflow for pulling and pushing images
          - Workflow pulls from ghcr.io/lpmi-13/k3s-remotelab-django
          - Version management

          The workflow will automatically pull and re-tag container images on push to main branch."

          # Push to Gitea
          REPO_URL="http://$USERNAME:$PASSWORD@gitea:3000/$USERNAME/$REPO_NAME.git"
          echo "Pushing code to Gitea repository..."
          git remote add origin "$REPO_URL"

          # Pull the auto-initialized repo first, then merge
          echo "Pulling auto-initialized repository..."
          git pull origin main --allow-unrelated-histories --no-edit || {
            echo "Pull failed, attempting force push..."
            git push -f -u origin main
          }

          # Now push our changes
          git push -u origin main

          echo "Repository initialized successfully!"

          # Enable Actions for the repository
          echo "Enabling Actions for repository..."
          curl -X PATCH "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d '{"has_actions": true}' || echo "Warning: Could not enable actions via API, may need manual enablement"

          # Create an API token for Gitea Actions to push to registry
          echo "Creating API token for Gitea Actions..."
          TOKEN_RESPONSE=$(curl -X POST "$GITEA_URL/api/v1/users/$USERNAME/tokens" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d "{
              \"name\": \"gitea-actions-token\",
              \"scopes\": [\"write:package\", \"write:repository\", \"write:user\"]
            }" 2>/dev/null || echo "")

          API_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"sha1":"[^"]*"' | cut -d'"' -f4)

          if [ -n "$API_TOKEN" ]; then
            echo "API token created successfully"
            echo "Storing token as repository secret..."

            # Try to create repository secret via API (if available in Gitea 1.20)
            curl -X PUT "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME/actions/secrets/GITEA_TOKEN" \
              -H "Content-Type: application/json" \
              -u "$USERNAME:$PASSWORD" \
              -d "{
                \"data\": \"$API_TOKEN\"
              }" 2>/dev/null && echo "Secret created successfully" || echo "Note: Secret creation via API not available, workflow will use actor credentials"

            echo "API_TOKEN=$API_TOKEN" > /tmp/gitea-token.txt
          else
            echo "Warning: Could not create API token. Workflow will use actor credentials."
            echo "The remotelab user credentials provide sufficient access for the workflow."
          fi

          echo ""
          echo "=========================================="
          echo "Repository initialization complete!"
          echo "=========================================="
          echo "Repository URL: $GITEA_URL/$USERNAME/$REPO_NAME"
          echo ""
          echo "Note: Initial deployment will use ghcr.io/$GHCR_IMAGE"
          echo "Future deployments will use Gitea registry after workflow runs"
          echo "=========================================="
