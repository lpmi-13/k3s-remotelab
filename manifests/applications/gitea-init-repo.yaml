apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-init-repo
  namespace: applications
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: gitea-init-repo
      annotations:
        linkerd.io/inject: disabled
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-gitea
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          echo "Waiting for Gitea to be ready..."
          attempts=0
          max_attempts=60
          until curl -sf http://gitea:3000/api/healthz > /dev/null; do
            attempts=$((attempts + 1))
            if [ $attempts -ge $max_attempts ]; then
              echo "Gitea failed to become ready after $max_attempts attempts"
              exit 1
            fi
            echo "Gitea not ready yet, waiting... (attempt $attempts/$max_attempts)"
            sleep 5
          done
          echo "Gitea is ready!"
          sleep 5
      containers:
      - name: init-repo
        image: alpine/git:latest
        command:
        - sh
        - -c
        - |
          set -ex

          # Install curl and jq for API calls
          apk add --no-cache curl jq

          echo "=========================================="
          echo "Initializing Django App Repository"
          echo "=========================================="

          GITEA_URL="http://gitea:3000"
          USERNAME="remotelab"
          PASSWORD="remotelab"
          REPO_NAME="django-app"
          GHCR_IMAGE="ghcr.io/lpmi-13/k3s-remotelab-django:latest"
          GITEA_REGISTRY="gitea:3000"
          GITEA_IMAGE="$GITEA_REGISTRY/$USERNAME/$REPO_NAME:1.0.1"

          # Check if repository exists
          echo "Checking if repository exists..."
          REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME")

          if [ "$REPO_CHECK" = "200" ]; then
            echo "Repository already exists. Checking if it needs reinitialization..."

            # Check if repository has the expected content (Django app and workflow)
            REPO_CONTENT=$(curl -s -u "$USERNAME:$PASSWORD" "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME/contents")

            if echo "$REPO_CONTENT" | grep -q "manage.py" && echo "$REPO_CONTENT" | grep -q ".gitea"; then
              echo "Repository already has correct content. Skipping reinitialization."
              echo "=========================================="
              echo "Django app repository already initialized!"
              echo "=========================================="
              echo "Repository URL: $GITEA_URL/$USERNAME/$REPO_NAME"
              exit 0
            fi

            echo "Repository exists but missing expected content. Deleting for fresh initialization..."
            curl -X DELETE "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME" \
              -u "$USERNAME:$PASSWORD" || {
                echo "Failed to delete existing repository"
                exit 1
              }
            sleep 3
          fi

          # Create repository under user account
          echo "Creating repository '$REPO_NAME' for user '$USERNAME'..."
          CREATE_RESPONSE=$(curl -X POST "$GITEA_URL/api/v1/user/repos" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d "{
              \"name\": \"$REPO_NAME\",
              \"description\": \"Django Application with CI/CD\",
              \"private\": false,
              \"auto_init\": true,
              \"default_branch\": \"main\"
            }")

          echo "Repository creation response: $CREATE_RESPONSE"

          # Wait a moment for repository to be fully initialized
          sleep 5

          # Configure git
          git config --global user.email "remotelab@localhost.local"
          git config --global user.name "Remotelab"
          git config --global init.defaultBranch main

          # Clone the source code from GitHub to get workflow files
          echo "Cloning repository from GitHub to get workflow configuration..."
          GITHUB_REPO="https://github.com/lpmi-13/k3s-remotelab.git"
          CLONE_DIR="/tmp/source"
          REPO_DIR="/workspace/repo"

          # Clone with retry logic for network resilience
          clone_attempts=0
          max_clone_attempts=5
          until git clone --depth 1 "$GITHUB_REPO" "$CLONE_DIR" 2>&1; do
            clone_attempts=$((clone_attempts + 1))
            if [ $clone_attempts -ge $max_clone_attempts ]; then
              echo "Failed to clone repository after $max_clone_attempts attempts"
              echo "This may be due to network issues or GitHub rate limiting."
              exit 1
            fi
            echo "Clone attempt $clone_attempts failed, retrying in 10 seconds..."
            rm -rf "$CLONE_DIR" 2>/dev/null || true
            sleep 10
          done

          echo "Successfully cloned repository from GitHub"

          # Prepare repository directory with Django app code
          echo "Extracting Django app workflow configuration from repository..."
          mkdir -p "$REPO_DIR"

          # Copy Django app directory contents
          if [ ! -d "$CLONE_DIR/sample-django-app" ]; then
            echo "Error: sample-django-app directory not found in cloned repository"
            echo "Contents of clone directory:"
            ls -la "$CLONE_DIR/"
            exit 1
          fi

          # Copy all files including hidden ones (.gitea directory)
          cp -r "$CLONE_DIR/sample-django-app/"* "$REPO_DIR/"
          # Explicitly copy hidden directories and files
          if [ -d "$CLONE_DIR/sample-django-app/.gitea" ]; then
            cp -r "$CLONE_DIR/sample-django-app/.gitea" "$REPO_DIR/"
            echo "Copied .gitea directory"
          fi
          if [ -f "$CLONE_DIR/sample-django-app/.gitignore" ]; then
            cp "$CLONE_DIR/sample-django-app/.gitignore" "$REPO_DIR/"
            echo "Copied .gitignore file"
          fi

          # Verify Django app was copied correctly
          cd "$REPO_DIR"
          if [ ! -f "manage.py" ]; then
            echo "Error: Django source code not properly copied"
            echo "Contents of repository directory:"
            ls -la "$REPO_DIR/"
            exit 1
          fi

          echo "Django app extracted successfully"

          # Fix registry hostname in workflow file (GitHub has external hostname, we need internal)
          echo "Updating workflow to use internal registry hostname..."
          echo "Looking for workflow files:"
          find "$REPO_DIR/.gitea" -name "*.yml" -o -name "*.yaml" 2>/dev/null || echo "No .gitea directory found"

          # Handle both .yml and .yaml extensions
          for workflow_file in "$REPO_DIR/.gitea/workflows/build.yml" "$REPO_DIR/.gitea/workflows/build.yaml"; do
            if [ -f "$workflow_file" ]; then
              echo "Processing: $workflow_file"
              echo "Before update:"
              grep -i "registry" "$workflow_file" | head -5
              # Replace any variation of the external hostname with internal service name
              sed -i 's/gitea\.remotelab\.local/gitea:3000/g' "$workflow_file"
              sed -i 's/gitea-registry\.local/gitea:3000/g' "$workflow_file"
              sed -i 's/localhost\/v2/gitea:3000/g' "$workflow_file"

              # Write a clean workflow file optimized for internal HTTP registry
              cat > "$workflow_file" << 'WORKFLOW_EOF'
          name: Build and Push Docker Image

          on:
            push:
              branches: [main, develop]
              tags: ['v*.*.*']
            pull_request:
              branches: [main]

          env:
            REGISTRY: gitea:3000
            IMAGE_NAME: django-app

          jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - uses: actions/setup-python@v4
                  with:
                    python-version: '3.11'
                - name: Install and test
                  env:
                    FORCE_SCRIPT_NAME: ''
                  run: |
                    pip install -r requirements.txt
                    python manage.py test

            build-and-push:
              needs: test
              runs-on: ubuntu-latest
              if: gitea.ref == 'refs/heads/main'
              steps:
                - uses: actions/checkout@v4

                - name: Get version
                  id: version
                  run: |
                    VERSION=$(grep "BASE_VERSION = " version.py | cut -d'"' -f2)
                    echo "version=${VERSION}.${{ gitea.run_number }}" >> $GITHUB_OUTPUT

                - name: Configure registry auth
                  run: |
                    mkdir -p ~/.docker
                    # Using remotelab credentials (lab environment)
                    AUTH=$(echo -n "remotelab:remotelab" | base64 -w 0)
                    echo "{\"auths\":{\"${{ env.REGISTRY }}\":{\"auth\":\"${AUTH}\"}}}" > ~/.docker/config.json

                - name: Build image
                  run: |
                    IMAGE="${{ env.REGISTRY }}/${{ gitea.repository_owner }}/${{ env.IMAGE_NAME }}"
                    docker build -t ${IMAGE}:${{ steps.version.outputs.version }} -t ${IMAGE}:latest .

                - name: Push to registry
                  run: |
                    apt-get update -qq && apt-get install -y -qq skopeo > /dev/null
                    IMAGE="${{ env.REGISTRY }}/${{ gitea.repository_owner }}/${{ env.IMAGE_NAME }}"
                    # Using remotelab credentials (lab environment)
                    skopeo copy --dest-tls-verify=false \
                      --dest-creds="remotelab:remotelab" \
                      docker-daemon:${IMAGE}:${{ steps.version.outputs.version }} \
                      docker://${IMAGE}:${{ steps.version.outputs.version }}
                    skopeo copy --dest-tls-verify=false \
                      --dest-creds="remotelab:remotelab" \
                      docker-daemon:${IMAGE}:latest \
                      docker://${IMAGE}:latest

            package-and-push-helm:
              needs: build-and-push
              runs-on: ubuntu-latest
              if: gitea.ref == 'refs/heads/main'
              steps:
                - uses: actions/checkout@v4

                - name: Get version
                  id: version
                  run: |
                    VERSION=$(grep "BASE_VERSION = " version.py | cut -d'"' -f2)
                    echo "version=${VERSION}.${{ gitea.run_number }}" >> $GITHUB_OUTPUT

                - name: Install Helm
                  run: |
                    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

                - name: Update Chart metadata
                  run: |
                    cd chart/django-app
                    sed -i "s/^version:.*/version: 0.1.${{ gitea.run_number }}/" Chart.yaml
                    sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" Chart.yaml
                    sed -i "s/tag: .*/tag: ${{ steps.version.outputs.version }}/" values.yaml
                    echo "Updated Chart.yaml:"
                    cat Chart.yaml

                - name: Package Helm chart
                  run: |
                    cd chart
                    helm package django-app

                - name: Push Helm chart to OCI registry
                  run: |
                    cd chart
                    # Use curl to push directly to Gitea's package API (bypasses OCI auth issues)
                    CHART_FILE="django-app-0.1.${{ gitea.run_number }}.tgz"
                    curl -X PUT \
                      -u "remotelab:remotelab" \
                      -H "Content-Type: application/octet-stream" \
                      --data-binary "@${CHART_FILE}" \
                      "http://${{ env.REGISTRY }}/api/packages/remotelab/helm/api/charts" \
                      && echo "Helm chart pushed to Gitea package registry"

            security-scan:
              needs: build-and-push
              runs-on: ubuntu-latest
              if: gitea.ref == 'refs/heads/main'
              steps:
                - name: Run Trivy vulnerability scanner
                  run: |
                    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
                    echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | tee -a /etc/apt/sources.list.d/trivy.list
                    apt-get update -qq
                    apt-get install -y -qq trivy > /dev/null
                    trivy image --insecure --format table \
                      --severity HIGH,CRITICAL \
                      ${{ env.REGISTRY }}/${{ gitea.repository_owner }}/${{ env.IMAGE_NAME }}:latest || true
          WORKFLOW_EOF

              echo "Workflow file created:"
              cat "$workflow_file"
            fi
          done

          echo "Repository contents:"
          ls -la "$REPO_DIR/"

          # Initialize git repository
          echo "Initializing git repository..."
          git init
          echo "Checking .gitea directory contents before adding:"
          find .gitea -type f
          git add -A
          git add -f .gitea/
          echo "Files staged for commit:"
          git status
          git commit -m "Initial commit: Django application with Gitea Actions CI/CD

          This commit includes:
          - Django application code
          - Gitea Actions workflow for pulling and pushing images
          - Workflow pulls from ghcr.io/lpmi-13/k3s-remotelab-django
          - Version management

          The workflow will automatically pull and re-tag container images on push to main branch."

          # Push to Gitea
          REPO_URL="http://$USERNAME:$PASSWORD@gitea:3000/$USERNAME/$REPO_NAME.git"
          echo "Pushing code to Gitea repository..."
          git remote add origin "$REPO_URL"

          # Pull the auto-initialized repo first, then merge
          echo "Pulling auto-initialized repository..."
          if git pull origin main --allow-unrelated-histories --no-edit 2>&1; then
            echo "Successfully merged with existing repository"
            # Now push our changes
            if git push -u origin main 2>&1; then
              echo "Successfully pushed to origin"
            else
              echo "Push failed after successful merge. This may indicate a concurrent modification."
              exit 1
            fi
          else
            echo "Pull failed, attempting force push..."
            if git push -f -u origin main 2>&1; then
              echo "Successfully force pushed to origin"
            else
              echo "Force push failed. Repository may be locked or network issue."
              exit 1
            fi
          fi

          echo "Repository initialized successfully!"

          # Install Helm and push initial chart to OCI registry
          echo "Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

          echo "Packaging initial Helm chart..."
          cd "$REPO_DIR/chart"
          helm package django-app

          echo "Pushing initial Helm chart to Gitea package registry..."
          curl -X PUT \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@django-app-0.1.0.tgz" \
            "http://gitea:3000/api/packages/remotelab/helm/api/charts" \
            && echo "Initial Helm chart pushed to Gitea package registry"

          # Enable Actions for the repository
          echo "Enabling Actions for repository..."
          curl -X PATCH "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d '{"has_actions": true}' || echo "Warning: Could not enable actions via API, may need manual enablement"

          # Create an API token for Gitea Actions to push to registry
          echo "Creating API token for Gitea Actions..."
          TOKEN_RESPONSE=$(curl -X POST "$GITEA_URL/api/v1/users/$USERNAME/tokens" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d "{
              \"name\": \"gitea-actions-token\",
              \"scopes\": [\"write:package\", \"write:repository\", \"write:user\"]
            }" 2>/dev/null || echo "")

          API_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"sha1":"[^"]*"' | cut -d'"' -f4)

          # Determine which credential to use for registry auth
          if [ -n "$API_TOKEN" ]; then
            echo "API token created successfully"
            REGISTRY_CREDENTIAL="$API_TOKEN"
            echo "API_TOKEN=$API_TOKEN" > /tmp/gitea-token.txt
          else
            echo "Warning: Could not create API token. Using user password for registry auth."
            REGISTRY_CREDENTIAL="$PASSWORD"
          fi

          # Create the REGISTRY_TOKEN secret for workflow to use
          echo "Creating REGISTRY_TOKEN secret for workflow..."
          curl -X PUT "$GITEA_URL/api/v1/repos/$USERNAME/$REPO_NAME/actions/secrets/REGISTRY_TOKEN" \
            -H "Content-Type: application/json" \
            -u "$USERNAME:$PASSWORD" \
            -d "{
              \"data\": \"$REGISTRY_CREDENTIAL\"
            }" 2>/dev/null && echo "REGISTRY_TOKEN secret created successfully" || echo "Warning: Could not create secret"

          echo ""
          echo "=========================================="
          echo "Repository initialization complete!"
          echo "=========================================="
          echo "Repository URL: $GITEA_URL/$USERNAME/$REPO_NAME"
          echo ""
          echo "Note: Initial deployment will use ghcr.io/$GHCR_IMAGE"
          echo "Future deployments will use Gitea registry after workflow runs"
          echo "=========================================="
